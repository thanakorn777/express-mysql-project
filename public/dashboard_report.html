<!-- public/dashboard.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ - Mission Hospital</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .header-logo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #f0f0f0;
      padding: 1rem;
    }

    .table-actions button {
      border: none;
      background: none;
      margin: 0 3px;
    }

    .table-actions i {
      font-size: 1rem;
      cursor: pointer;
    }

    .status-dot {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 50%;
  }
  .urgent { background-color: red; }
  .normal { background-color: gold; }
  .not_urgent { background-color: green; }

  </style>
</head>
<body class="bg-light">

<div class="container d-flex flex-column align-items-center py-4">
  <!-- Header -->
  <div class="w-100 mb-3">
    <div class="header-logo rounded shadow-sm">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Adventist_logo.svg/1200px-Adventist_logo.svg.png" height="50">
      <h4 class="mb-0">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô Mission Hospital</h4>
      <div class="d-flex gap-2">
        <a href="dashboard_information.html" class="btn btn-success">‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
        <a href="add_information.html" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
        <a href="dashboard_report.html" class="btn btn-secondary position-relative">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a>
        <a href="report_issue.html" class="btn btn-warning">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="w-100 d-flex justify-content-between align-items-center mb-2 px-3">
    <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    <h5 class="text-center mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h5>
    <div>
      <input type="text" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="searchInput" style="max-width: 300px;">
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive w-100">
    <table class="table table-bordered align-middle w-100">
      <thead class="table-secondary text-center">
        <tr>
          <th scope="col">Name</th>
          <th scope="col">Department</th>
          <th scope="col">IP Address</th>
          <th scope="col">Tel</th>
          <th scope="col">Note</th>
          <th scope="col">CreateDate</th>
          <th scope="col">Status</th>
          <th scope="col">Delete</th>
        </tr>
      </thead>
      <tbody id="reportTableBody">
        <!-- Data will be inserted here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Script: Load Data -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetch('/api/dashboard_report')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById("reportTableBody");
        const totalCount = document.getElementById("totalCount");
        tbody.innerHTML = "";
        totalCount.innerText = data.length;
        
        data.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.department}</td>
            <td>${item.ip_address}</td>
            <td>${item.tel}</td>
            <td>${item.note || '-'}</td>
            <td>${formatThaiDate(item.created_at)}</td>
            <td class="text-center">
              <span class="status-dot ${getStatusColor(item.status)}" title="${item.status}"></span>
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-light" onclick="deleteReport(${item.id})">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });

    function formatThaiDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString("th-TH", { hour: '2-digit', minute: '2-digit' }) + ' ' +
             date.toLocaleDateString("th-TH");
    }

    function statusColor(status) {
      switch (status) {
        case 'new': return 'bg-danger';
        case 'in_progress': return 'bg-warning';
        case 'resolved': return 'bg-success';
        default: return 'bg-secondary';
      }
    }
  });

  // üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏î
  document.getElementById('searchInput').addEventListener('input', function () {
    const keyword = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      if (text.includes(keyword)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  function deleteReport(id) {
    if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
      fetch(`/dashboard_report/${id}`, {
        method: 'DELETE',
      })
      .then(res => {
        if (res.ok) {
          alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          location.reload();

        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
        }
      });
    }
  }

  function getStatusColor(status) {
  switch (status) {
    case 'urgent': return 'urgent';
    case 'normal': return 'normal';
    case 'not_urgent': return 'not_urgent';
    default: return 'bg-secondary';
  }
}

</script>
</body>
</html>
